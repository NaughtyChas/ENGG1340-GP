name: Build Windows EXE

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: ['**']

jobs:
  build-windows:
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-ncurses
          make
          
    - name: Find ncurses headers and create compatibility layer
      shell: msys2 {0}
      run: |
        echo "Finding ncurses.h..."
        NCURSES_HEADERS=$(find /mingw64 -name "ncurses.h" 2>/dev/null)
        echo "Found ncurses.h files: $NCURSES_HEADERS"
        
        CURSES_HEADERS=$(find /mingw64 -name "curses.h" 2>/dev/null)
        echo "Found curses.h files: $CURSES_HEADERS"
        
        if [ -n "$NCURSES_HEADERS" ]; then
          echo "Using system ncurses.h: $NCURSES_HEADERS"
          NCURSES_DIR=$(dirname $(echo "$NCURSES_HEADERS" | head -1))
          echo "Using directory: $NCURSES_DIR"
        else
          if [ -n "$CURSES_HEADERS" ]; then
            CURSES_PATH=$(echo "$CURSES_HEADERS" | head -1)
            echo "Found curses.h, creating ncurses.h wrapper..."
            echo '#ifndef NCURSES_H_INCLUDED' > include/ncurses.h
            echo '#define NCURSES_H_INCLUDED' >> include/ncurses.h
            echo "#include \"$CURSES_PATH\"" >> include/ncurses.h
            echo '#endif' >> include/ncurses.h
          else
            echo "No curses.h or ncurses.h found, creating generic wrapper..."
            echo '#ifndef NCURSES_H_INCLUDED' > include/ncurses.h
            echo '#define NCURSES_H_INCLUDED' >> include/ncurses.h
            echo '#include <ncursesw/curses.h>' >> include/ncurses.h
            echo '#endif' >> include/ncurses.h
          fi
        fi
        
        echo "====== System Directory Info ======"
        ls -la /mingw64/include/ncurses* 2>/dev/null || echo "No ncurses* in include dir"
        ls -la /mingw64/include/ncursesw* 2>/dev/null || echo "No ncursesw* in include dir"
        echo "======================="
    
    - name: Create build directories
      shell: msys2 {0}
      run: mkdir -p bin build
      
    - name: Build application
      shell: msys2 {0}
      run: |
        sed -i 's/TARGET = $(BIN_DIR)\/main/TARGET = $(BIN_DIR)\/main.exe/g' Makefile
        
        export CXXFLAGS="-I/mingw64/include/ncursesw -I/mingw64/include/ncurses -I/mingw64/include"
        
        echo "Curses-related files in system:"
        find /mingw64 -name "*curses*.h" | sort
        
        if [ -f "/mingw64/lib/libncurses.dll.a" ]; then
          sed -i 's/-lncurses/-lncurses/g' Makefile
        elif [ -f "/mingw64/lib/libncursesw.dll.a" ]; then
          sed -i 's/-lncurses/-lncursesw/g' Makefile
        elif [ -f "/mingw64/lib/libpdcurses.a" ]; then
          sed -i 's/-lncurses/-lpdcurses/g' Makefile
        fi
        
        echo "Available library files:"
        ls -la /mingw64/lib/lib*curses*
        
        make VERBOSE=1
      
    - name: Package executable with dependencies
      shell: msys2 {0}
      run: |
        mkdir -p package
        cp bin/main.exe package/game.exe
        cp /mingw64/bin/libncursesw*.dll package/
        cp /mingw64/bin/libgcc_s_seh-1.dll package/
        cp /mingw64/bin/libstdc++-6.dll package/
        cp /mingw64/bin/libwinpthread-1.dll package/
        
        cp /mingw64/bin/libiconv*.dll package/
        cp /mingw64/bin/libintl*.dll package/
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: windows-game-executable
        path: package/
        retention-days: 14
        if-no-files-found: error