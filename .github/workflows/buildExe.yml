name: Build Windows EXE

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: ['**']

jobs:
  build-windows:
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-pdcurses
          make
          
    - name: Locate PDCurses and create compatibility layer
      shell: msys2 {0}
      run: |
        # Locate PDCurses header file first
        CURSES_PATH=$(find /mingw64 -name "curses.h" | head -1)
        echo "Found curses.h at: $CURSES_PATH"
        
        CURSES_DIR=$(dirname "$CURSES_PATH")
        echo "#include \"$CURSES_PATH\"" > /mingw64/include/ncurses.h
        
        mkdir -p include/compat
        cp "$CURSES_PATH" include/compat/
        echo "#include \"../compat/curses.h\"" > include/ncurses.h
    
    - name: Create build directories
      shell: msys2 {0}
      run: mkdir -p bin build
      
    - name: Build application
      shell: msys2 {0}
      run: |
        sed -i 's/TARGET = $(BIN_DIR)\/main/TARGET = $(BIN_DIR)\/main.exe/g' Makefile
        sed -i 's/-lncurses/-lpdcurses/g' Makefile
        sed -i 's/CXXFLAGS = -std=c++14/CXXFLAGS = -std=c++14 -I\/mingw64\/include\/pdcurses/g' Makefile
        
        # 显示所有可用的头文件位置
        echo "======= AVAILABLE INCLUDE PATHS ======="
        find /mingw64/include -name "*curses*.h"
        echo "======================================"
        
        # 添加更多诊断信息
        export CXXFLAGS="-v"
        
        make
      
    - name: Package executable with dependencies
      shell: msys2 {0}
      run: |
        mkdir -p package
        cp bin/main.exe package/game.exe
        cp /mingw64/bin/libpdcurses.dll package/
        cp /mingw64/bin/libgcc_s_seh-1.dll package/
        cp /mingw64/bin/libstdc++-6.dll package/
        cp /mingw64/bin/libwinpthread-1.dll package/
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: windows-game-executable
        path: package/
        retention-days: 14
        if-no-files-found: error